<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR 查看器</title>
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            color: white;
            transition: opacity 0.5s ease;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 20px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .loading-text {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .error-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 999;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .error-icon {
            font-size: 48px;
            color: #f72585;
            margin-bottom: 20px;
        }
        
        .back-button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #4361ee;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s ease;
        }
        
        .back-button:hover {
            background-color: #3a0ca3;
        }
        
        .instructions {
            position: fixed;
            bottom: 20px;
            left: 0;
            width: 100%;
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.5);
            padding: 10px;
            font-size: 14px;
            z-index: 10;
        }
    </style>
</head>
<body>
    <div id="loadingScreen" class="loading-screen">
        <div class="spinner"></div>
        <div class="loading-text">正在加载AR内容...</div>
        <div id="loadingProgress">准备中...</div>
    </div>
    
    <div id="errorScreen" class="error-screen">
        <div class="error-icon">⚠️</div>
        <h2>加载失败</h2>
        <p id="errorMessage">无法加载AR内容，请检查您的链接或返回主页。</p>
        <button class="back-button" onclick="window.location.href='index.html'">返回主页</button>
    </div>
    
    <div class="instructions">
        将相机对准标记图像以查看AR内容
    </div>
    
    <a-scene
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true"
        id="scene">
        
        <a-assets id="assets">
            <!-- 资源将通过JavaScript动态加载 -->
        </a-assets>
        
        <a-marker id="arMarker" type="pattern" url="" smooth="true" smoothCount="5" smoothTolerance="0.01" smoothThreshold="2">
            <!-- AR内容将通过JavaScript动态添加 -->
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>
    
    <script>
        // 获取URL参数
        function getUrlParam(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }
        
        // 显示错误
        function showError(message) {
            document.getElementById('loadingScreen').style.display = 'none';
            document.getElementById('errorScreen').style.display = 'flex';
            document.getElementById('errorMessage').textContent = message || '无法加载AR内容，请检查您的链接或返回主页。';
            console.error('AR加载错误:', message);
        }
        
        // 更新加载进度
        function updateLoadingProgress(text) {
            document.getElementById('loadingProgress').textContent = text;
            console.log('加载进度:', text);
        }
        
        // 初始化AR查看器
        async function initARViewer() {
            try {
                // 获取内容ID
                const contentId = getUrlParam('id');
                if (!contentId) {
                    showError('未提供内容ID，无法加载AR内容。');
                    return;
                }
                
                updateLoadingProgress('正在获取内容数据...');
                console.log('查找内容ID:', contentId);
                
                // 从本地存储获取内容
                const storedContents = localStorage.getItem('arContents');
                if (!storedContents) {
                    showError('未找到任何AR内容数据。请确保您已在主页创建了AR内容。');
                    console.error('本地存储中没有arContents数据');
                    return;
                }
                
                let contents;
                try {
                    contents = JSON.parse(storedContents);
                    console.log('解析的内容数据:', contents);
                } catch (e) {
                    showError('AR内容数据格式错误。');
                    console.error('JSON解析错误:', e);
                    return;
                }
                
                const content = contents.find(item => item.id === contentId);
                
                if (!content) {
                    showError(`未找到ID为 ${contentId} 的AR内容。`);
                    console.error('未找到匹配的内容:', contentId);
                    return;
                }
                
                console.log('找到内容:', content);
                updateLoadingProgress('正在准备AR标记...');
                
                // 使用内容中的标记图像
                const marker = document.getElementById('arMarker');
                
                // 对于AR.js，我们需要使用预定义的标记模式
                // 这里我们使用默认的hiro标记
                marker.setAttribute('preset', 'hiro');
                
                updateLoadingProgress('正在加载AR内容...');
                
                // 根据内容类型创建不同的AR内容
                const contentType = content.type;
                const contentData = content.contentFile;
                
                // 清除标记内容
                while (marker.firstChild) {
                    marker.removeChild(marker.firstChild);
                }
                
                // 根据内容类型添加不同的实体
                if (contentType === 'image') {
                    // 添加图像
                    const image = document.createElement('a-image');
                    image.setAttribute('src', contentData);
                    image.setAttribute('position', '0 0 0');
                    image.setAttribute('rotation', '-90 0 0');
                    image.setAttribute('width', '1');
                    image.setAttribute('height', '1');
                    marker.appendChild(image);
                } else if (contentType === 'video') {
                    // 添加视频
                    const assets = document.getElementById('assets');
                    const video = document.createElement('video');
                    video.setAttribute('id', 'arVideo');
                    video.setAttribute('src', contentData);
                    video.setAttribute('preload', 'auto');
                    video.setAttribute('loop', '');
                    video.setAttribute('crossorigin', 'anonymous');
                    video.muted = true;
                    assets.appendChild(video);
                    
                    const videoPlane = document.createElement('a-video');
                    videoPlane.setAttribute('src', '#arVideo');
                    videoPlane.setAttribute('position', '0 0 0');
                    videoPlane.setAttribute('rotation', '-90 0 0');
                    videoPlane.setAttribute('width', '1.5');
                    videoPlane.setAttribute('height', '1');
                    marker.appendChild(videoPlane);
                    
                    // 当标记被检测到时播放视频
                    marker.addEventListener('markerFound', () => {
                        video.play();
                    });
                    
                    // 当标记丢失时暂停视频
                    marker.addEventListener('markerLost', () => {
                        video.pause();
                    });
                } else if (contentType === '3d') {
                    // 添加3D模型
                    const model = document.createElement('a-entity');
                    model.setAttribute('gltf-model', contentData);
                    model.setAttribute('position', '0 0 0');
                    model.setAttribute('rotation', '-90 0 0');
                    model.setAttribute('scale', '0.5 0.5 0.5');
                    marker.appendChild(model);
                }
                
                updateLoadingProgress('AR内容已准备就绪！');
                
                // 隐藏加载屏幕
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                    }, 500);
                }, 1000);
                
            } catch (error) {
                console.error('AR初始化错误:', error);
                showError('初始化AR内容时发生错误: ' + error.message);
            }
        }
        
        // 页面加载完成后初始化AR查看器
        window.addEventListener('load', initARViewer);
        
        // 添加调试信息
        console.log('页面加载完成，URL参数:', window.location.search);
        console.log('本地存储内容:', localStorage.getItem('arContents'));
    </script>
</body>
</html>